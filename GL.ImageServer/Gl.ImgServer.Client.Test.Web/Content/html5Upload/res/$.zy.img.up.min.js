///<jscompress sourcefile="zyFile.js" />
/*
www.198zone.com
*////<jscompress sourcefile="zyUpload.js" />
/*
www.198zone.com
*/var ZYFILE={fileInput:null,uploadInput:null,dragDrop:null,url:"",uploadFile:[],lastUploadFile:[],perUploadFile:[],fileNum:0,filterFile:function(a){return a},onSelect:function(a,b){},onDelete:function(a,b){},onProgress:function(a,b,e){},onSuccess:function(a,b){},onFailure:function(a,b){},onComplete:function(a){},funDragHover:function(a){a.stopPropagation();a.preventDefault();this["dragover"===a.type?"onDragOver":"onDragLeave"].call(a.target);return this},funGetFiles:function(a){var b=this;this.funDragHover(a);a=a.target.files||a.dataTransfer.files;b.lastUploadFile=this.uploadFile;this.uploadFile=this.uploadFile.concat(this.filterFile(a));var e=[],d=[],k=[];$.each(b.lastUploadFile,function(a,b){d.push(b.name)});$.each(b.uploadFile,function(a,b){k.push(b.name)});$.each(k,function(a,m){0>$.inArray(m,d)&&e.push(b.uploadFile[a])});this.uploadFile=e;this.funDealtFiles();return!0},funDealtFiles:function(){var a=this;$.each(this.uploadFile,function(b,d){d.index=a.fileNum;a.fileNum++});var b=this.uploadFile;this.perUploadFile=this.perUploadFile.concat(this.uploadFile);this.uploadFile=this.lastUploadFile.concat(this.uploadFile);this.onSelect(b,this.uploadFile);console.info("\u7ee7\u7eed\u9009\u62e9");console.info(this.uploadFile);return this},funDeleteFile:function(a,b){var e=[],d=this.perUploadFile[a];console.info(d);$.each(this.uploadFile,function(a,b){d!=b&&e.push(b)});this.uploadFile=e;if(b)this.onDelete(d,this.uploadFile);console.info("\u8fd8\u5269\u8fd9\u4e9b\u6587\u4ef6\u6ca1\u6709\u4e0a\u4f20:");console.info(this.uploadFile);return!0},funUploadFiles:function(){var a=this;$.each(this.uploadFile,function(b,e){a.funUploadFile(e)})},funUploadFile:function(a){var b=this,e=new FormData;e.append("fileList",a);var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(d){b.onProgress(a,d.loaded,d.total)},!1);d.addEventListener("load",function(e){b.funDeleteFile(a.index,!1);b.onSuccess(a,d.responseText);if(0==b.uploadFile.length)b.onComplete("\u5168\u90e8\u5b8c\u6210")},!1);d.addEventListener("error",function(e){b.onFailure(a,d.responseText)},!1);d.open("POST",b.url,!0);d.setRequestHeader("X_FILENAME",a.name);d.send(e)},funReturnNeedFiles:function(){return this.uploadFile},init:function(){var a=this;this.dragDrop&&(this.dragDrop.addEventListener("dragover",function(b){a.funDragHover(b)},!1),this.dragDrop.addEventListener("dragleave",function(b){a.funDragHover(b)},!1),this.dragDrop.addEventListener("drop",function(b){a.funGetFiles(b)},!1));a.fileInput&&this.fileInput.addEventListener("change",function(b){a.funGetFiles(b)},!1);a.uploadInput&&this.uploadInput.addEventListener("click",function(b){a.funUploadFiles(b)},!1)}};(function(a,b){a.fn.zyUpload=function(b,d){var e=Array.prototype.slice.call(arguments,1);if("string"==typeof b){var l=this[0][b];if(a.isFunction(l))return l.apply(this,e);throw"zyUpload - No such method: "+b;}return this.each(function(){var d={},e=this,d=a.extend({width:"700px",height:"400px",itemWidth:"140px",itemHeight:"120px",url:"/upload/UploadAction",multiple:!0,dragDrop:!0,del:!0,finishDel:!1,onSelect:function(a,c){},onDelete:function(a,c){},onSuccess:function(a){},onFailure:function(a){},onComplete:function(a){}},b);this.init=function(){this.createHtml();this.createCorePlug()};this.createHtml=function(){var b="";d.multiple?b="multiple":b="";var c="";if(d.dragDrop)c+='\x3cform id\x3d"uploadForm" action\x3d"'+d.url+'" method\x3d"post" enctype\x3d"multipart/form-data"\x3e',c=c+'\t\x3cdiv class\x3d"upload_box"\x3e\t\t\x3cdiv class\x3d"upload_main"\x3e\t\t\t\x3cdiv class\x3d"upload_choose"\x3e\t\t\t\t\x3cdiv class\x3d"convent_choice"\x3e\t\t\t\t\t\x3cdiv class\x3d"andArea"\x3e\t\t\t\t\t\t\x3cdiv class\x3d"filePicker"\x3e\u70b9\u51fb\u9009\u62e9\u6587\u4ef6\x3c/div\x3e'+('\t\t\t\t\t\t\x3cinput id\x3d"fileImage" type\x3d"file" size\x3d"30" name\x3d"fileselect[]" '+b+"\x3e")+"\t\t\t\t\t\x3c/div\x3e\t\t\t\t\x3c/div\x3e",c+='\t\t\t\t\x3cspan id\x3d"fileDragArea" class\x3d"upload_drag_area"\x3e\u6216\u8005\u5c06\u6587\u4ef6\u62d6\u5230\u6b64\u5904\x3c/span\x3e',c+="\t\t\t\x3c/div\x3e",c+='\t\t\t\x3cdiv class\x3d"status_bar"\x3e',c+='\t\t\t\t\x3cdiv id\x3d"status_info" class\x3d"info"\x3e\u9009\u4e2d0\u5f20\u6587\u4ef6\uff0c\u51710B\u3002\x3c/div\x3e',c+='\t\t\t\t\x3cdiv class\x3d"btns"\x3e',c+='\t\t\t\t\t\x3cdiv class\x3d"webuploader_pick"\x3e\u7ee7\u7eed\u9009\u62e9\x3c/div\x3e',c+='\t\t\t\t\t\x3cdiv class\x3d"upload_btn"\x3e\u5f00\u59cb\u4e0a\u4f20\x3c/div\x3e',c+="\t\t\t\t\x3c/div\x3e",c+="\t\t\t\x3c/div\x3e",c+='\t\t\t\x3cdiv id\x3d"preview" class\x3d"upload_preview"\x3e\x3c/div\x3e';else var g=parseInt(d.itemWidth.replace("px",""))-15,c=c+('\x3cform id\x3d"uploadForm" action\x3d"'+d.url+'" method\x3d"post" enctype\x3d"multipart/form-data"\x3e'),c=c+'\t\x3cdiv class\x3d"upload_box"\x3e',c=c+'\t\t\x3cdiv class\x3d"upload_main single_main"\x3e',c=c+'\t\t\t\x3cdiv class\x3d"status_bar"\x3e',c=c+'\t\t\t\t\x3cdiv id\x3d"status_info" class\x3d"info"\x3e\u9009\u4e2d0\u5f20\u6587\u4ef6\uff0c\u51710B\u3002\x3c/div\x3e',c=c+'\t\t\t\t\x3cdiv class\x3d"btns"\x3e',c=c+('\t\t\t\t\t\x3cinput id\x3d"fileImage" type\x3d"file" size\x3d"30" name\x3d"fileselect[]" '+b+"\x3e")+'\t\t\t\t\t\x3cdiv class\x3d"webuploader_pick"\x3e\u9009\u62e9\u6587\u4ef6\x3c/div\x3e\t\t\t\t\t\x3cdiv class\x3d"upload_btn"\x3e\u5f00\u59cb\u4e0a\u4f20\x3c/div\x3e',c=c+"\t\t\t\t\x3c/div\x3e",c=c+"\t\t\t\x3c/div\x3e",c=c+'\t\t\t\x3cdiv id\x3d"preview" class\x3d"upload_preview"\x3e',c=c+'\t\t\t\t\x3cdiv class\x3d"add_upload"\x3e',c=c+('\t\t\t\t\t\x3ca style\x3d"height:'+d.itemHeight+";width:"+d.itemWidth+';" title\x3d"\u70b9\u51fb\u6dfb\u52a0\u6587\u4ef6" id\x3d"rapidAddImg" class\x3d"add_imgBox" href\x3d"javascript:void(0)"\x3e'),c=c+('\t\t\t\t\t\t\x3cdiv class\x3d"uploadImg" style\x3d"width:'+g+'px"\x3e'),c=c+('\t\t\t\t\t\t\t\x3cimg class\x3d"upload_image" src\x3d"control/images/add_img.png" style\x3d"width:expression(this.width \x3e '+g+" ? "+g+'px : this.width)" /\x3e'),c=c+"\t\t\t\t\t\t\x3c/div\x3e",c=c+"\t\t\t\t\t\x3c/a\x3e",c=c+"\t\t\t\t\x3c/div\x3e",c=c+"\t\t\t\x3c/div\x3e";c+="\t\t\x3c/div\x3e";c+='\t\t\x3cdiv class\x3d"upload_submit"\x3e';c+='\t\t\t\x3cbutton type\x3d"button" id\x3d"fileSubmit" class\x3d"upload_submit_btn"\x3e\u786e\u8ba4\u4e0a\u4f20\u6587\u4ef6\x3c/button\x3e';c+="\t\t\x3c/div\x3e";c+='\t\t\x3cdiv id\x3d"uploadInf" class\x3d"upload_inf"\x3e\x3c/div\x3e';c+="\t\x3c/div\x3e";c+="\x3c/form\x3e";a(e).append(c).css({width:d.width,height:d.height});this.addEvent()};this.funSetStatusInfo=function(b){var c=0,g=b.length;a.each(b,function(a,b){c+=b.size});c=1048576<c?(Math.round(100*c/1048576)/100).toString()+"MB":(Math.round(100*c/1024)/100).toString()+"KB";a("#status_info").html("\u9009\u4e2d"+g+"\u5f20\u6587\u4ef6\uff0c\u5171"+c+"\u3002")};this.funFilterEligibleFile=function(a){for(var c=[],b=0,d;d=a[b];b++)512E5<=d.size?alert('\u60a8\u8fd9\u4e2a"'+d.name+'"\u6587\u4ef6\u5927\u5c0f\u8fc7\u5927'):c.push(d);return c};this.funDisposePreviewHtml=function(a,c){var b="",e=parseInt(d.itemWidth.replace("px",""))-15,h="";d.del&&(h='\x3cspan class\x3d"file_del" data-index\x3d"'+a.index+'" title\x3d"\u5220\u9664"\x3e\x3c/span\x3e');var f="control/images/fileType/",f=0<a.type.indexOf("rar")?f+"rar.png":0<a.type.indexOf("zip")?f+"zip.png":0<a.type.indexOf("text")?f+"txt.png":f+"file.png";0==a.type.indexOf("image")?(b+='\x3cdiv id\x3d"uploadList_'+a.index+'" class\x3d"upload_append_list"\x3e',b=b+'\t\x3cdiv class\x3d"file_bar"\x3e\t\t\x3cdiv style\x3d"padding:5px;"\x3e'+('\t\t\t\x3cp class\x3d"file_name"\x3e'+a.name+"\x3c/p\x3e"),b=b+h+"\t\t\x3c/div\x3e\t\x3c/div\x3e",b+='\t\x3ca style\x3d"height:'+d.itemHeight+";width:"+d.itemWidth+';" href\x3d"#" class\x3d"imgBox"\x3e',b+='\t\t\x3cdiv class\x3d"uploadImg" style\x3d"width:'+e+'px"\x3e',b+='\t\t\t\x3cimg id\x3d"uploadImage_'+a.index+'" class\x3d"upload_image" src\x3d"'+c.target.result+'" style\x3d"width:expression(this.width \x3e '+e+" ? "+e+'px : this.width)" /\x3e'):(b+='\x3cdiv id\x3d"uploadList_'+a.index+'" class\x3d"upload_append_list"\x3e',b+='\t\x3cdiv class\x3d"file_bar"\x3e',b+='\t\t\x3cdiv style\x3d"padding:5px;"\x3e',b+='\t\t\t\x3cp class\x3d"file_name"\x3e'+a.name+"\x3c/p\x3e",b=b+h+"\t\t\x3c/div\x3e\t\x3c/div\x3e",b+='\t\x3ca style\x3d"height:'+d.itemHeight+";width:"+d.itemWidth+';" href\x3d"#" class\x3d"imgBox"\x3e',b+='\t\t\x3cdiv class\x3d"uploadImg" style\x3d"width:'+e+'px"\x3e',b+='\t\t\t\x3cimg id\x3d"uploadImage_'+a.index+'" class\x3d"upload_image" src\x3d"'+f+'" style\x3d"width:expression(this.width \x3e '+e+" ? "+e+'px : this.width)" /\x3e');b+="\t\t\x3c/div\x3e";b+="\t\x3c/a\x3e";b+='\t\x3cp id\x3d"uploadProgress_'+a.index+'" class\x3d"file_progress"\x3e\x3c/p\x3e';b+='\t\x3cp id\x3d"uploadFailure_'+a.index+'" class\x3d"file_failure"\x3e\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\x3c/p\x3e';b+='\t\x3cp id\x3d"uploadSuccess_'+a.index+'" class\x3d"file_success"\x3e\x3c/p\x3e';return b+="\x3c/div\x3e"};this.createCorePlug=function(){var b={fileInput:a("#fileImage").get(0),uploadInput:a("#fileSubmit").get(0),dragDrop:a("#fileDragArea").get(0),url:a("#uploadForm").attr("action"),filterFile:function(a){return e.funFilterEligibleFile(a)},onSelect:function(c,b){d.onSelect(c,b);e.funSetStatusInfo(ZYFILE.funReturnNeedFiles());var g="",h=0,f=function(){if(file=c[h]){var a=new FileReader;a.onload=function(a){g+=e.funDisposePreviewHtml(file,a);h++;f()};a.readAsDataURL(file)}else n(g)},n=function(c){d.dragDrop?a("#preview").append(c):a(".add_upload").before(c);k();l()},k=function(){0<a(".file_del").length&&a(".file_del").click(function(){ZYFILE.funDeleteFile(parseInt(a(this).attr("data-index")),!0);return!1});0<a(".file_edit").length&&a(".file_edit").click(function(){return!1})},l=function(){a(".upload_append_list").hover(function(c){a(this).find(".file_bar").addClass("file_hover")},function(c){a(this).find(".file_bar").removeClass("file_hover")})};f()},onDelete:function(c,b){a("#uploadList_"+c.index).fadeOut();e.funSetStatusInfo(b);console.info("\u5269\u4e0b\u7684\u6587\u4ef6");console.info(b)},onProgress:function(c,b,d){c=a("#uploadProgress_"+c.index);b=(b/d*100).toFixed(2)+"%";c.is(":hidden")&&c.show();c.css("width",b)},onSuccess:function(c,b){a("#uploadProgress_"+c.index).hide();a("#uploadSuccess_"+c.index).show();a("#uploadInf").append("\x3cp\x3e\u4e0a\u4f20\u6210\u529f\uff0c\u6587\u4ef6\u5730\u5740\u662f\uff1a"+b+"\x3c/p\x3e");d.finishDel&&(a("#uploadList_"+c.index).fadeOut(),e.funSetStatusInfo(ZYFILE.funReturnNeedFiles()))},onFailure:function(c){a("#uploadProgress_"+c.index).hide();a("#uploadSuccess_"+c.index).show();a("#uploadInf").append("\x3cp\x3e\u6587\u4ef6"+c.name+"\u4e0a\u4f20\u5931\u8d25\uff01\x3c/p\x3e")},onComplete:function(a){console.info(a)},onDragOver:function(){a(this).addClass("upload_drag_hover")},onDragLeave:function(){a(this).removeClass("upload_drag_hover")}};ZYFILE=a.extend(ZYFILE,b);ZYFILE.init()};this.addEvent=function(){0<a(".filePicker").length&&a(".filePicker").bind("click",function(b){a("#fileImage").click()});a(".webuploader_pick").bind("click",function(b){a("#fileImage").click()});a(".upload_btn").bind("click",function(b){0<ZYFILE.funReturnNeedFiles().length?a("#fileSubmit").click():alert("\u8bf7\u5148\u9009\u4e2d\u6587\u4ef6\u518d\u70b9\u51fb\u4e0a\u4f20")});0<a("#rapidAddImg").length&&a("#rapidAddImg").bind("click",function(b){a("#fileImage").click()})};this.init()})}})(jQuery);